define("dateManager",function(require){var $=require("jquery");var dateSelectorV2=require("dateSelectorV2");var helpers=require("helpers");var create=function(formManager){var peopleManager=null;var self={init:function(){self.cacheDom();self.wrapSelectors();self.attachHandlers();self.attachWidgets();self.attachPikaHandlers();self.setDefaultTexts();self.setDisplays();return self},setPeopleManager:function(newPeopleManager){peopleManager=newPeopleManager},dom:{},cacheDom:function(){self.dom.dateSelectors=formManager.dom.bookingTypes.find(".booking-option.date-selector");self.dom.dateSelectorWrapper=formManager.dom.bookingWidget.find(".date-selector-wrapper")},wrapSelectors:function(){self.dom.bookingOptions=formManager.dom.bookingTypes.find(".booking-options");self.dom.bookingOptions.each(function(index){var elementDates=$(this).find(".booking-option.date-selector");var count=0;var checkinOut=elementDates.filter(function(index){var subElement=$(this);var checkin=elementDates.hasClass("checkin-date");var checkout=elementDates.hasClass("checkout-date");if(checkin||checkout){count++;return subElement}});if(count===2){checkinOut.wrapAll('<li class="booking-option-wrapper"></li>')}})},resetDateSelector:function(){var $this=$(this),clickTimeOffset=Date.now()-$this.data("booking-widget.opened-at"),dateOpenClass="open";formManager.selectorClose(peopleManager.dom.peopleSelectors,"open");formManager.selectorClose(formManager.dom.bookingTypeSelectContainer,"open select-open");if(isNaN(clickTimeOffset)||clickTimeOffset<50){formManager.selectorOpen($this,dateOpenClass);return}formManager.showHideSelector($this,dateOpenClass)},closeDateSelectors:function(){self.dom.dateSelectors.filter(".date-open").removeClass("date-open");self.resizeDateSelects()},openDateSelector:function($elem){self.closeDateSelectors();$elem.addClass("date-open");if($elem.hasClass("checkout-date")){$elem.prev().addClass("date-open")}else if($elem.hasClass("checkin-date")){$elem.next().addClass("date-open")}self.resizeDateSelects();self.attachPikaHandlers();if(!helpers.isSquaw){if($(".checkout-date").hasClass("open")&&$(".checkin-date").hasClass("closed")){$(".checkin-date").removeClass("closed");$(".checkin-date").addClass("open")}}},resizeDateSelects:function(){var openSelectors=self.dom.dateSelectors.filter(".date-open"),closedSelectors=self.dom.dateSelectors.not(".date-open"),isTabletOrDesktop=Modernizr.mq("only screen and (min-width: 768px)");if(isTabletOrDesktop){self.dom.dateSelectors.css({"margin-top":""});return}closedSelectors.css({"margin-top":""});openSelectors.each(function(){var $this=$(this),isCheckin=$this.hasClass("checkin-date"),isCheckout=$this.hasClass("checkout-date"),$dateSelectorWrapper=$this.find(".date-selector-wrapper"),dateSelectorWrapperHeight=$dateSelectorWrapper.height();var isDateLeft=$this.is(".complementary.left");var isDateRight=$this.is(".complementary.right");if(isCheckout){return}if(isCheckin||isDateLeft||isDateRight){var $otherDateSelector=null;if(isCheckin||isDateLeft){$otherDateSelector=$this.next()}if(isDateRight){$otherDateSelector=$this.prev()}var $otherDateSelectorWrapper=$otherDateSelector.find(".date-selector-wrapper"),otherDateSelectorWrapperHeight=$otherDateSelectorWrapper.height();dateSelectorWrapperHeight=otherDateSelectorWrapperHeight>dateSelectorWrapperHeight?otherDateSelectorWrapperHeight:dateSelectorWrapperHeight;$otherDateSelector.css({"margin-top":dateSelectorWrapperHeight})}$this.css({"margin-top":dateSelectorWrapperHeight})})},closeDateSelector:function($elem){self.closeDateSelectors();$elem.removeClass("date-open");if($elem.hasClass("checkout-date")){$elem.prev().removeClass("date-open");if(!helpers.isSquaw){$elem.prev().removeClass("open");$elem.prev().addClass("closed")}}else if($elem.hasClass("checkin-date")){$elem.next().removeClass("date-open");if(!helpers.isSquaw){$elem.next().removeClass("open");$elem.next().addClass("closed")}}},dateSelectorReset:function(){self.dom.dateSelectors.each(function(){var element=$(this);formManager.selectorClose(element,"open")})},setDefaultTexts:function(){formManager.dom.bookingTypes.each(function(i,e){var $bookingType=$(e),$dateSelectors=$bookingType.find(".date-selector");$dateSelectors.each(function(){var $this=$(this),$label=$this.find(".booking-option-label"),$text=$label.find(".text");if($label.find(".subtext").length===0){$label.prepend('<div class="subtext"></div>')}if(!$text.attr("data-default-text")){$text.attr("data-default-text",$label.text())}})})},setDisplays:function(){formManager.dom.bookingTypes.each(function(i,e){var $bookingType=$(e),$dateSelectors=$bookingType.find(".date-selector"),$checkinDate=$dateSelectors.filter(".checkin-date"),$checkoutDate=$dateSelectors.filter(".checkout-date"),$otherDates=$dateSelectors.not(".checkin-date, .checkout-date").filter(".date-selected"),$checkinBookingOptionLabel=$checkinDate.find(".booking-option-label"),$checkoutBookingOptionLabel=$checkoutDate.find(".booking-option-label"),$checkinSubText=$checkinBookingOptionLabel.find(".subtext"),$checkoutSubText=$checkoutBookingOptionLabel.find(".subtext"),$checkinText=$checkinBookingOptionLabel.find(".text"),$checkoutText=$checkoutBookingOptionLabel.find(".text"),isTabletOrDesktop=Modernizr.mq("only screen and (min-width: 768px)"),checkinDefaultText=$checkinText.attr("data-default-text"),checkoutDefaultText=$checkoutText.attr("data-default-text"),combinedDefaultText=checkinDefaultText+"\\"+checkoutDefaultText,i18N=dateSelectorV2.getI18N();$otherDates.each(function(){var $this=$(this),$subtext=$this.find(".subtext"),$text=$this.find(".text"),date=$this.dateSelectorV2("get")._d,dateTimeStr=self.getDisplayDate(date,i18N);$subtext.text($text.attr("data-default-text"));$text.html('<span class="selection">'+dateTimeStr+"</span>");if(Modernizr.mq("only screen and (max-width: 767px)")){var subtextStyle="width:auto; display:inline-block;";$subtext.attr("style",subtextStyle)}});if($checkinDate.length<=0||$checkoutDate.length<=0){return}var checkinDateTime=$checkinDate.dateSelectorV2("get")._d,checkoutDateTime=$checkoutDate.dateSelectorV2("get")._d,checkinDateTimeStr=self.getDisplayDate(checkinDateTime,i18N),checkoutDateTimeStr=self.getDisplayDate(checkoutDateTime,i18N),combinedDateTimeStr=checkoutDateTimeStr!==""?checkinDateTimeStr+" - "+checkoutDateTimeStr:checkinDateTimeStr;if(!$checkinDate.hasClass("date-selected")){$checkinSubText.text("");$checkinText.text(isTabletOrDesktop?combinedDefaultText:checkinDefaultText)}else{$checkinSubText.text(isTabletOrDesktop?combinedDefaultText:checkinDefaultText);$checkinText.text(isTabletOrDesktop?combinedDateTimeStr:checkinDateTimeStr)}if(!$checkoutDate.hasClass("date-selected")){$checkoutSubText.text("");$checkoutText.text(checkoutDefaultText)}else{$checkoutSubText.text(checkoutDefaultText);$checkoutText.text(checkoutDateTimeStr)}})},getDisplayDate:function(d,i18N){return d?d.getDate()+" "+i18N.monthsShort[d.getMonth()]:""},onDateSelected:function(){var $parent=this.$element.closest(".booking-option"),thisPicker=this.$element.dateSelectorV2("get"),nextListItem=$parent.next(".booking-option.date-selector"),nextPicker=$parent.next(".booking-option.date-selector").dateSelectorV2("get"),prevPicker=$parent.prev(".booking-option.date-selector").dateSelectorV2("get"),selectedDate=this.getDate(),tomorrowDayOfMonth=selectedDate.getDate()+1,selectedMonth=selectedDate.getMonth(),selectedYear=selectedDate.getFullYear(),selectedDatePlusOne=new Date(parseInt(selectedYear),parseInt(selectedMonth),parseInt(tomorrowDayOfMonth));nextPickerHasMonth=nextPicker?nextPicker._d:false,nextPickerMonth=nextPickerHasMonth?nextPicker._d.getMonth():false,nextPickerYear=nextPickerHasMonth?nextPicker._d.getFullYear():false;formManager.selectorClose($(".booking-option.date-selector"),"open");this.$element.addClass("date-selected");if(nextPicker){formManager.selectorOpen(nextListItem,"open");nextPicker.setMinDate(selectedDatePlusOne);if(nextPicker.getDate()<=selectedDate||helpers.dateToUrlStringFormat(nextPicker._d)!==nextPicker._o.field.value){nextPicker.setDate();nextPicker.setEndRange();thisPicker.setEndRange();nextPicker._o.field.value=helpers.dateToUrlStringFormat(selectedDatePlusOne)}nextPicker.setStartRange(selectedDate);thisPicker.setStartRange(selectedDate);if(!nextPickerMonth||nextPickerMonth!==selectedMonth){nextPicker.gotoMonth(selectedMonth)}if(!nextPickerMonth||nextPickerYear!==selectedYear){nextPicker.gotoYear(selectedYear)}nextPicker.draw();nextPicker.show()}if(prevPicker){prevPicker.draw();prevPicker.setEndRange(selectedDate);thisPicker.setEndRange(selectedDate)}self.setDisplays();self.resizeDateSelects();self.attachPikaHandlers()},onDatePickerOpened:function(){this.$element.data("booking-widget.opened-at",Date.now())},attachHandlers:function(){self.dom.dateSelectors.on("click",self.resetDateSelector);self.dom.dateSelectorWrapper.on("click",function(e){e.stopPropagation()})},attachPikaHandlers:function(){var buttons=formManager.dom.bookingWidget.find(".pika-prev, .pika-next"),buttonsToHandle=buttons.not(".handled");buttonsToHandle.addClass("handled").on("touchend mousedown",function(){self.resizeDateSelects();setTimeout(self.resizeDateSelects,50);self.attachPikaHandlers()})},attachWidgets:function(){self.dom.dateSelectors.each(function(index,element){var $el=$(element),$input=$el.find("input"),minDateString=$el.data("min-date"),minDate=minDateString&&minDateString.length>0?new Date(minDateString):new Date,defValStr=$input.data("default-value"),defVal=defValStr&&defValStr.length>0?new Date(defValStr):new Date;$el.dateSelectorV2({additionalLabel:".booking-option-label",trigger:".booking-option-label-container",onOpen:self.onDatePickerOpened,onSelect:self.onDateSelected,preventHideOnSelect:false,minDate:minDate,defaultDate:defVal,numberOfMonths:2,index:index,sectionId:"fbw"})})}};return self.init()};return{create:create}});