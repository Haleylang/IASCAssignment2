define(function(require){"use strict";require("peopleManager");require("dateManager");var helpers=require("helpers"),dropdown=require("dropdown"),rangeDateManager=require("bookingRangeDateManager"),singleDateManager=require("bookingSingleDateManager"),$=require("jquery"),selectedBookingType,dom,mobileSelectionsOpen=true,mobileBreakpoint=Modernizr.mq("only screen and (min-width: 768px)"),widgetTop=0,windowTop=0,footerTop=0,optionsSet=false,enableSticky=true,peopleSelectorConfig={},isMobile=!helpers.windowWidthsGreaterThan(767);return init();function init(){cacheDom();rangeDateManager=rangeDateManager.create(dom);singleDateManager=singleDateManager.create(dom);configurePeopleSelectorParameterNames();createHiddenInputs();setInitialButtonHrefs();disableOnMobile();setDropdowns();attachHandlers();attachWidgets();selectInitialType();showWidget();renamePeopleSelectors();if(enableSticky){setSticky();stickyBookingWidget()}initBookingOptionHandlers()}function cacheDom(){dom={};dom.window=helpers.dom.window;dom.bookingWidgetSpacer=$(".booking-widget-spacer").not(".footer-booking-widget-spacer");dom.bookingWidget=dom.bookingWidgetSpacer.find(".booking-widget");dom.footer=$("footer");dom.header=$("header");dom.mobileBookingWidget=$(".mobile-booking-widget");dom.bookingWidgetWrapper=dom.bookingWidgetSpacer.find(".booking-widget-wrapper");dom.bookingTypes=dom.bookingWidget.find(".booking-type");dom.bookingTypeForms=dom.bookingWidgetSpacer.find(".booking-type form");dom.inputs=dom.bookingTypeForms.find("input, select");dom.desktopPeopleSelectors=dom.bookingTypeForms.find(".desktop.people-selector input");dom.mobilePeopleSelectors=dom.bookingTypeForms.find(".mobile.people-selector select");dom.submitLinks=dom.bookingTypeForms.find(".booking-type-submit .submit");dom.dateSelectors=dom.bookingTypes.find(".booking-option.date-selector");dom.peopleSelectors=dom.bookingTypes.find(".booking-option.people-selector");dom.peopleSelectorWrappers=dom.peopleSelectors.find(".people-selector-wrapper");dom.peopleSelectorWidgets=dom.peopleSelectorWrappers.find(".people-selector-widget");dom.bookingTypeSelectContainer=dom.bookingWidget.find(".booking-type-select");dom.bookingTypeSelectLabel=dom.bookingWidget.find(".booking-type-select-label");dom.bookingTypeSelect=dom.bookingWidget.find(".booking-type-options-wrapper");dom.selectedOption=dom.bookingWidget.find(".selected-option");dom.bookingOptions=dom.bookingWidgetSpacer.find(".booking-option");dom.dateSelectorWrapper=dom.bookingWidget.find(".date-selector-wrapper");dom.dropdownSelectors=dom.bookingWidget.find(".airport-selector, .time-selector, .month-selector, .days-selector, .agecategory-selector");dom.dropdownSelectorWidgets=dom.bookingWidget.find(".airport-selector-wrapper, .time-selector-wrapper, .month-selector-wrapper, .days-selector-wrapper, .agecategory-selector-wrapper");dom.nativeDropdowns=dom.bookingWidget.find(".dropdown-wrapper");dom.customDropdowns=dom.bookingWidget.find(".dropdown-selection");dom.checkoutDate=dom.bookingWidget.find(".checkout-date");updatePositioningValuesAndSetHeight()}function configurePeopleSelectorParameterNames(){dom.desktopPeopleSelectors.each(function(){if($(this).attr("name")){peopleSelectorConfig[$(this).attr("title")]=$(this).attr("name").toLowerCase()}})}function updatePositioningValuesAndSetHeight(){var hadSticky,hadFooter;if(dom.bookingWidgetWrapper.hasClass("sticky")){hadSticky=true;dom.bookingWidgetWrapper.removeClass("sticky")}if(dom.bookingWidgetWrapper.hasClass("footer-attached")){hadFooter=true;dom.bookingWidgetWrapper.removeClass("footer-attached")}widgetTop=dom.bookingWidgetWrapper.offset().top;footerTop=dom.footer.offset().top;dom.bookingWidgetSpacer.height(dom.bookingWidgetWrapper.height());if(hadSticky){dom.bookingWidgetWrapper.addClass("sticky")}if(hadFooter){dom.bookingWidgetWrapper.addClass("footer-attached")}}function createHiddenInputs(){dom.bookingTypeForms.each(function(){var $form=$(this),action=$form.attr("action"),actionHash=$form.data("url-hash"),actionParts=action.split("?"),hashPairs=action.split("#"),keyValuePairs,keyValue,i,hiddenEl,$hiddenEl,newAction;if(actionParts.length<2&&actionHash.length<1&&hashPairs.length<2){return}if(actionParts.length<2){newAction=action;if(actionHash.length<1&&hashPairs.length>1){$form.data("url-hash",hashPairs[1]);newAction=hashPairs[0]}$form.attr("action",newAction);return}hashPairs=actionParts[1].split("#");keyValuePairs=hashPairs[0].split("&");for(i=0;i<keyValuePairs.length;i+=1){keyValue=keyValuePairs[i].split("=");if(keyValue.length<2){continue}hiddenEl=document.createElement("input");$hiddenEl=$(hiddenEl);$hiddenEl.attr("type","hidden");$hiddenEl.attr("name",keyValue[0]);$hiddenEl.attr("value",keyValue[1]);$form.append($hiddenEl)}newAction=actionParts[0];if(actionHash.length<1&&hashPairs.length>1){$form.data("url-hash",hashPairs[1])}$form.attr("action",newAction)})}function attachHandlers(){var isHeroWidget=dom.bookingWidgetWrapper.parents(".hero-wrapper").length>0||dom.bookingWidgetWrapper.parents(".hero-wrapper-v2").length>0;dom.window.on("resize",helpers.debounce(resizeProcesses,100,true));var bookingTypeSelectToggle=dom.bookingWidgetSpacer.find(".booking-type-select-toggle");if(bookingTypeSelectToggle.is(":disabled")){bookingTypeSelectToggle.off("click");bookingTypeSelectToggle.off("touchstart")}else{bookingTypeSelectToggle.on("click touchstart",activitySelectToggle)}dom.bookingWidgetWrapper.on("click",function(e){if(!helpers.isPageEditor){e.stopPropagation()}});$(document.body).on("click",function(){$(".booking-option").trigger("booking:close",true);closeAllOptions(true)});dom.peopleSelectors.on("click",".booking-option-label-container, .booking-option, .booking-option.people-selector",showHidePeopleSelector).on("peopleSelector.updated",function(e){$(this).find(".booking-option-label").text(e.message)});var isDesktop=Modernizr.mq("only screen and (min-width: 768px)");if(isDesktop){dom.dateSelectors.on("click",resetDateSelector);dom.dateSelectorWrapper.on("click",function(e){e.stopPropagation()})}else{dom.dateSelectors.on("touchstart",resetDateSelector);dom.dateSelectorWrapper.on("touchstart",function(e){e.stopPropagation()})}dom.bookingTypeForms.on("submit",checkFormValues);dom.inputs.on("change",updateButtonLinkHref);dom.submitLinks.on("mousedown",updateButtonLinkHref);if(!helpers.isPageEditor&&enableSticky&&!isHeroWidget){dom.window.on("scroll",stickyBookingWidget);dom.window.on("resize",helpers.debounce(updatePositioningValuesAndSetHeight,100,true))}}function closeAllOptions(closeDropdowns){if(closeDropdowns){closeDropdownOptions()}selectorClose(dom.bookingTypeSelectContainer,"select-open");peopleDateSelectorReset();$(".booking-option").trigger("booking:close",false)}function initBookingOptionHandlers(){dom.bookingOptions.each(function(i,e){var option=$(e);attachBookingOptionHandler(option)});dom.bookingTypeSelectContainer.each(function(i,e){var selectButton=$(".booking-type-select-toggle",$(this));attachBookingOptionHandler(selectButton)})}function attachBookingOptionHandler(opt){opt.on("click",function(e){var el=$(e.target);var bookingButton=el.closest(".booking-button");var clickElement=bookingButton.length==0?el:bookingButton;clickElement.trigger("booking:close")})}function activitySelectToggle(){showHideSelector(dom.bookingTypeSelectContainer,"select-open");peopleDateSelectorReset();$(".booking-option").trigger("booking:close",false)}function peopleDateSelectorReset(){selectorClose(dom.peopleSelectors,"open");dateSelectorReset()}function resetDateSelector(){var $this=$(this),dateOpenClass="open",clickTimeOffset=Date.now()-$this.data("booking-widget.opened-at");$this.data("booking-widget.opened-at",Date.now());selectorClose(dom.peopleSelectors,"open");selectorClose(dom.bookingTypeSelectContainer,"select-open");clickTimeOffset=Date.now()-$this.data("booking-widget.opened-at");if(isNaN(clickTimeOffset)||clickTimeOffset<50){selectorOpen($this,dateOpenClass);return}showHideDateSelector($this,dateOpenClass)}function closeDropdownOptions(){var thisDropdown;for(var i=0;i<dom.dropdowns.length;i++){thisDropdown=dom.dropdowns[i];if(thisDropdown.dom.context.hasClass("airport-selector")){thisDropdown.dom.context.find(".cover-button input").val("")}thisDropdown.closeDropdowns()}}function selectorOpen($this,openClass){closeDropdownOptions();dateSelectorReset();$this.removeClass("closed");$this.addClass(openClass)}function selectorClose($this,openClass){$this.removeClass(openClass);$this.addClass("closed")}function showHideSelector(parent,openClass){var open=parent.is("."+openClass);if(open){selectorClose(parent,openClass)}else{selectorOpen(parent,openClass)}}function showHidePeopleSelector(e){var parent=$(this).parent(".people-selector");selectorClose(dom.bookingTypeSelectContainer,"select-open");dateSelectorReset();showHideSelector(parent,"open")}function showHideDateSelector($this,openClass){selectorClose(dom.peopleSelectors,"open");selectorClose(dom.bookingTypeSelectContainer,"select-open");showHideSelector($this,openClass)}function dateSelectorReset(){dom.dateSelectors.each(function(){var element=$(this);selectorClose(element,"open")})}function resizeProcesses(){renamePeopleSelectors();var bookingWidgetV2=dom.bookingWidgetWrapper.closest(".hero-wrapper--has-booking-widget-v2");if(bookingWidgetV2&&bookingWidgetV2.length){return}closeAllOptions(true);$(".booking-option").trigger("booking:close",true);showOptions();setSticky()}function showOptions(){mobileBreakpoint=Modernizr.mq("only screen and (min-width: 768px)");if(mobileBreakpoint&&!optionsSet){mobileSelectionsOpen=true;optionsSet=true}}function setSticky(){var isHeroWidget=dom.bookingWidgetWrapper.parents(".hero-wrapper").length>0||dom.bookingWidgetWrapper.parents(".hero-wrapper-v2").length>0;if(!isHeroWidget){dom.bookingWidgetWrapper.addClass("needs-stick")}else{dom.bookingWidgetWrapper.removeClass("needs-stick")}}function renamePeopleSelectors(){var mobileBreakpoint=Modernizr.mq("only screen and (max-width: 767px)");if(mobileBreakpoint){dom.mobilePeopleSelectors.each(function(){$(this).attr("name",peopleSelectorConfig[$(this).attr("label")])});dom.desktopPeopleSelectors.removeAttr("name")}else{dom.desktopPeopleSelectors.each(function(){$(this).attr("name",peopleSelectorConfig[$(this).attr("label")])});dom.mobilePeopleSelectors.removeAttr("name")}}function stickyBookingWidget(){windowTop=dom.window.scrollTop();if(!dom.bookingWidgetWrapper.hasClass("sticky")&&windowTop>=widgetTop&&windowTop<footerTop){dom.bookingWidgetWrapper.addClass("sticky").removeClass("footer-attached")}else if(dom.bookingWidgetWrapper.hasClass("sticky")&&windowTop<widgetTop&&windowTop<footerTop){dom.bookingWidgetWrapper.removeClass("sticky").removeClass("footer-attached")}}function disableOnMobile(){dom.bookingTypeSelect.each(function(){$(this).addClass("disabled")})}function setDropdowns(){if(isMobile){dom.nativeDropdowns.removeClass("hidden")}else{dom.customDropdowns.removeClass("hidden")}dom.dropdowns=[];var selectTypeDropdown=dropdown.create({contextEl:dom.bookingTypeSelectContainer,dropdown:dom.bookingTypeSelectContainer,toggleSelector:".booking-type-select-toggle",toggleTextSelector:".booking-type-select-label",optionsSelector:".booking-type-options-wrapper",optionsButtonSelector:".booking-type-option",constrainWidth:false,openClass:" "});dom.dropdowns.push(selectTypeDropdown);dom.dropdownSelectors.each(function(){var $this=$(this);dom.dropdowns.push(dropdown.create({contextEl:$this,dropdown:$this.find(".dropdown-selection"),toggleSelector:".booking-option-label-container",toggleTextSelector:".text",optionsButtonSelector:"span",toggle:true,test:true,putOpenClassOnContext:true,constrainWidth:false,closeOptionsCallback:function(){$(".booking-option").trigger("booking:close",true);closeAllOptions(true)}}))})}function attachWidgets(){dom.peopleSelectorWidgets.peopleSelector();dom.dateSelectors.each(function(index,element){var $el=$(element),$input=$el.find("input"),minDateString=$el.data("min-date"),minDate=minDateString&&minDateString.length>0?new Date(minDateString):new Date,defValStr=$input.data("default-value"),defVal=defValStr&&defValStr.length>0?new Date(defValStr):new Date;$el.dateSelector({additionalLabel:".booking-option-label",trigger:".booking-option-label-container",onOpen:onDatePickerOpened,onSelect:onDateSelected,preventHideOnSelect:false,defaultDate:defVal,minDate:minDate,defLabel:$el.find("booking-option-label").text()})});dom.checkoutDate.each(function(i,e){dom.checkoutDate.eq(i).data("default-value",dom.checkoutDate.eq(i).find(".booking-option-label").text().trim())})}function onDateSelected(){var $parent=this.$element.closest(".booking-option");var thisPicker=this.$element.dateSelector("get");var nextListItem=$parent.next(".booking-option.date-selector");var nextPicker=$parent.next(".booking-option.date-selector").dateSelector("get");var prevPicker=$parent.prev(".booking-option.date-selector").dateSelector("get");var selectedDate=this.getDate();var selectedMonth=selectedDate.getMonth();var selectedYear=selectedDate.getFullYear();var nextPickerHasMonth=nextPicker?nextPicker._d:false;var nextPickerMonth=nextPickerHasMonth!==false&&nextPickerHasMonth?nextPicker._d.getMonth():false;var nextPickerYear=nextPickerHasMonth!==false&&nextPickerHasMonth?nextPicker._d.getFullYear():false;var selectedDatePlusOne=new Date((new Date).setDate(selectedDate.getDate()+1));selectorClose($(".booking-option.date-selector"),"open");$parent.closest(".booking-option").find(".booking-option-label").text(this.toString());if(nextPicker){selectorOpen(nextListItem,"open");nextPicker.setMinDate(selectedDatePlusOne);var checkoutText=dom.checkoutDate.data("default-value");if(nextPicker.getDate()<=selectedDate||helpers.dateToUrlStringFormat(nextPicker._d)!==nextPicker._o.field.value){nextListItem.closest(".booking-option").find(".booking-option-label").text(checkoutText);nextPicker.setDate();nextPicker.setEndRange();thisPicker.setEndRange();nextPicker._o.field.value=helpers.dateToUrlStringFormat(selectedDatePlusOne)}nextPicker.setStartRange(selectedDate);thisPicker.setStartRange(selectedDate);if(!nextPickerMonth||nextPickerMonth!==selectedMonth){nextPicker.gotoMonth(selectedMonth)}if(!nextPickerMonth||nextPickerYear!==selectedYear){nextPicker.gotoYear(selectedYear)}nextPicker.draw();nextPicker.show()}if(prevPicker){prevPicker.draw();prevPicker.setEndRange(selectedDate);thisPicker.setEndRange(selectedDate)}}function selectInitialType(){var selectedType=dom.bookingTypeSelect.find("li.selected");if(selectedType===null||selectedType===undefined||selectedType.length===0){dom.bookingTypeSelect.find("li:first-of-type").addClass("selected")}}function onDatePickerOpened(){this.$element.data("booking-widget.opened-at",Date.now())}function showWidget(){dom.bookingWidget.addClass("selection-loaded");dom.mobileBookingWidget.addClass("selection-loaded")}function checkFormValues(){var $form=$(this),$inputs=$form.find("input, select"),modifiedInputs=[],$input,inputVal,inputOrigVal,inputDefVal;$inputs.each(function(){$input=$(this);inputVal=$input.val();inputOrigVal=$input.attr("data-orig-value")||"";inputDefVal=$input.attr("data-default-value")||"";if(inputVal===inputOrigVal){$input.val(inputDefVal);modifiedInputs.push($input)}});window.setTimeout(function(){resetFormValues(modifiedInputs)},0);return true}function resetFormValues(inputs){$(inputs).each(function(){$(this).val($(this).data("orig-value"))})}function setInitialButtonHrefs(){dom.bookingTypeForms.each(function(index,item){updateButtonLinkHref.call(item)})}function updateButtonLinkHref(){var $formContextItem=$(this),$form=$formContextItem.closest("form"),$inputs=$form.find("input, select"),modifiedInputs=[],$input,inputVal,inputOrigVal,inputDefVal,newHref,actionHash,formTarget,$submitLink=$form.find(".booking-type-submit .submit"),serializeForm;$inputs.each(function(){$input=$(this);inputVal=$input.val();inputOrigVal=$input.attr("data-orig-value")||"";inputDefVal=$input.attr("data-default-value")||"";if(inputVal===inputOrigVal){$input.val(inputDefVal);modifiedInputs.push($input)}});serializeForm=$form.serialize();newHref=$form.attr("action")+(serializeForm.length>0?"?":"")+serializeForm;actionHash=$form.data("url-hash");formTarget=$form.attr("target");if(actionHash.length>0){newHref+="#"+actionHash}$submitLink.attr("href",newHref);$submitLink.attr("target",formTarget);resetFormValues(modifiedInputs)}});