define("inntopia-bundles",function(require){var minDate=new Date;minDate.setDate(minDate.getDate()-1);var $=require("jquery"),mustache=require("mustache"),helpers=require("helpers"),bundlesTemplatePath=require("text!/public/Shared/templates/bundles/inntopia-bundles.html"),selectedTemplatePath=require("text!/public/Shared/templates/bundles/selected-items.html"),overlayComponent=require("overlay"),overlay=null,stepFormComponent=require("step-form"),stepForm=null;defaults={getBundlesEndpoint:"/api/InntopiaBundles/GetBundles"};var create=function(options,parent){var self={parent:parent,options:$.extend({},defaults,options),editMode:false,farthestStep:0,displayData:{item:null,selected:[],subTotal:0},bundles:[],init:function(){self.initUI();self.bindEvents();return self},initUI:function(){var overlayOptions={closeCallback:self.overlayClosed};overlay=overlayComponent.create(overlayOptions)},bindEvents:function(){$(".inntopia-bundles").on("click",".option-select:not(.no-thanks)",self.selectOption);$(".inntopia-bundles").on("click",".bundle-option",self.selectLi);$(".inntopia-bundles").on("click",".bundle-option span",self.selectSpan);$(".inntopia-bundles").on("click",".option-select.no-thanks",self.selectNoThanks);$(".inntopia-bundles").on("click",".no-option",self.noThanksClick);$(".inntopia-bundles").on("click",".add-to-cart",self.addToCart);$(".inntopia-bundles").on("change",".option-qty",self.setQuantity);$(".inntopia-bundles").on("click",".more-options-button",self.showMoreOptions);$(".inntopia-bundles").on("click",".next-step",self.nextStep);$(".inntopia-bundles").on("click",".qty-box .control",self.qtyClick);$(".inntopia-bundles").on("click",".review-title",self.toggleReview);$(".inntopia-bundles").on("click",".cancel",self.cancel);$(".inntopia-bundles").on("click","li.done",self.editDone);$(".inntopia-bundles").on("click",".bundle .title",self.editBundle)},cancel:function(e){overlay.remove();parent.removeFromCart(parseInt(self.UpsellItemList));self.reset()},editBundle:function(e){var currentStep=stepForm.getCurrentStep();var currentBundle=self.bundles[currentStep-1];var newStep=$(this).parent().data("order");var newBundle=self.bundles[newStep-1];if(self.editMode){if(!self.validateBundle(currentBundle)){return}if(self.validateBundle(newBundle)){stepForm.goToStep(newStep)}}else if($(this).parent().hasClass("editable")){var farthestStep=self.farthestStep+1;if(currentStep==farthestStep&&newStep<currentStep){stepForm.goToStep(newStep)}else if(newStep<farthestStep&&self.validateBundle(currentBundle)){stepForm.goToStep(newStep)}}},toggleReview:function(e){$(".inntopia-bundles").toggleClass("expanded")},selectLi:function(e){e.stopPropagation();$(e.target).find(".option-select").click()},selectSpan:function(e){e.stopPropagation();$(e.target).closest("li").find(".option-select").click()},nextStep:function(e){var step=stepForm.getCurrentStep();self.farthestStep=step;var bundle=self.bundles[step-1];if(self.validateBundle(bundle)){$(e.target).closest(".bundle").addClass("editable")}if(!self.editMode){stepForm.nextStep()}if(self.validateAll()){$(".inntopia-bundles .add-to-cart").removeClass("disabled").removeAttr("disabled");$(".inntopia-bundles .bundles-list").addClass("edit");$(".inntopia-bundles").addClass("valid");if(!self.editMode&&step===self.bundles.length){$(".inntopia-bundles").addClass("expanded");self.editMode=true}}else{$(".inntopia-bundles .add-to-cart").addClass("disabled").attr("disabled","disabled");$(".inntopia-bundles").removeClass("valid")}},editDone:function(){if(self.validateAll()){$(".inntopia-bundles .add-to-cart").removeClass("disabled").removeAttr("disabled");$(".inntopia-bundles .bundles-list").addClass("edit");$(".inntopia-bundles").addClass("valid");stepForm.closeAll()}else{$(".inntopia-bundles .add-to-cart").addClass("disabled").attr("disabled","disabled");$(".inntopia-bundles").removeClass("valid")}if(!self.editMode){stepForm.goToStep(self.farthestStep+1)}},selectOption:function(e){e.stopPropagation();var target=e.target;var cartItem=$(target).data("cartitem");var bundleOptions=$(target).closest(".bundle-options");$(bundleOptions).find(".option-select.no-thanks").prop("checked",false);$(bundleOptions).find(".no-option").removeClass("selected");var bundleId=parseInt($(bundleOptions).data("bundleid"));var bundle=self.findBundle(bundleId);var max=bundle.MaxAddOn;var min=bundle.MinAddOn;var optional=bundle.Optional;if($(target).prop("checked")){if(min===1&&max===1&&!optional){var newSelected=[];self.displayData.selected.forEach(function(item){if(item.productBundleId!=bundleId){newSelected.push(item)}});self.displayData.selected=newSelected;$(bundleOptions).find(".bundle-option").removeClass("selected");$(bundleOptions).find(".option-select").prop("checked",false)}if(self.checkMaxQty(max-1,bundleId)){self.displayData.selected.push(cartItem);$(target).parent().find(".option-qty").val(min);$(target).parent().addClass("selected")}else{$(target).prop("checked",false)}}else{var newSelected=[];$(target).parent().removeClass("selected");self.displayData.selected.forEach(function(item){if(cartItem.id!=item.id){newSelected.push(item)}else{cartItem.quantity=1}});self.displayData.selected=newSelected}self.finalizeStep(bundle,bundleOptions)},qtyClick:function(e){var target=e.target;var value=parseInt($(target).siblings(".option-qty").val());if($(target).hasClass("plus")){value++}else{value--}if(value==0){value=1}$(target).siblings(".option-qty").val(value);$(target).siblings(".option-qty").change()},setQuantity:function(e){var target=e.target;var bundleOptions=$(target).closest(".bundle-options");var productId=parseInt($(target).data("productid"));var supplierId=parseInt($(target).data("supplierid"));var bundleId=parseInt($(bundleOptions).data("bundleid"));var bundle=self.findBundle(bundleId);var max=bundle.MaxAddOn;var value=parseInt($(target).val());var currentQty=0;self.displayData.selected.forEach(function(cartItem){if(cartItem.productId===productId&&cartItem.supplierId===supplierId){currentQty=cartItem.quantity;cartItem.quantity=value;if(!self.checkMaxQty(max,bundleId)){cartItem.quantity=currentQty;$(target).val(currentQty)}}});self.finalizeStep(bundle,bundleOptions)},finalizeStep:function(bundle,bundleOptions){var valid=self.validateBundle(bundle);self.renderSelected();if(valid){if(self.bundleEditable(bundle.ProductBundleId)){$(bundleOptions).find(".done").show()}else{$(bundleOptions).find(".next-step").show()}$(bundleOptions).find(".no-option").hide()}else{$(bundleOptions).find(".next-step, .done").hide();$(bundleOptions).find(".no-option").show()}},noThanksClick:function(e){$(e.target).find(".no-thanks").click()},selectNoThanks:function(e){var target=e.target;var bundleOptions=$(target).closest(".bundle-options");$(bundleOptions).find(".option-select:not(.no-thanks)").prop("checked",false);$(bundleOptions).find(".bundle-option").removeClass("selected");$(bundleOptions).find(".no-option").toggleClass("selected");var bundleId=parseInt($(bundleOptions).data("bundleid"));var bundle=self.findBundle(bundleId);var newSelected=[];self.displayData.selected.forEach(function(item){if(item.productBundleId!=bundleId){newSelected.push(item)}});self.displayData.selected=newSelected;self.renderSelected();if(self.validateBundle(bundle)){if(self.bundleEditable(bundle.ProductBundleId)){$(bundleOptions).find(".done").show()}else{$(bundleOptions).find(".next-step").show()}}else{$(bundleOptions).find(".next-step, .done").hide();$(bundleOptions).find(".no-option").show()}},checkMaxQty:function(max,bundleId){var count=0;self.displayData.selected.forEach(function(item){if(item.productBundleId===bundleId){count+=parseInt(item.quantity)}});if(count<=max){return true}return false},checkMinQty:function(min,bundleId){var count=0;self.displayData.selected.forEach(function(item){if(item.productBundleId===bundleId){count+=item.quantity}});if(count>=min){return true}return false},validateBundle:function(bundle){var valid=true;var min=bundle.MinAddOn;var max=bundle.MaxAddOn;var optional=bundle.Optional;var bundleId=bundle.ProductBundleId;var noThanks=$(".no-thanks-"+bundleId).prop("checked");if(!optional){noThanks=false}if(!noThanks){if(!self.checkMaxQty(max,bundleId)){valid=false}if(!self.checkMinQty(min,bundleId)){valid=false}}if(valid){$(".bundle-"+bundleId).addClass("valid")}else{$(".bundle-"+bundleId).removeClass("valid")}return valid},validateAll:function(){var valid=true;var allNoThanks=true;self.bundles.forEach(function(bundle){var min=bundle.MinAddOn;var max=bundle.MaxAddOn;var optional=bundle.Optional;var bundleId=bundle.ProductBundleId;var noThanks=$(".no-thanks-"+bundleId).prop("checked");if(!optional){noThanks=false}if(!noThanks){if(!self.checkMaxQty(max,bundleId)){valid=false}if(!self.checkMinQty(min,bundleId)){valid=false}allNoThanks=false}});if(allNoThanks){$(".inntopia-bundles button.add-to-cart").html(self.displayData.Text.NoSelection)}else{$(".inntopia-bundles button.add-to-cart").html(self.displayData.Text.AddToCart)}return valid},getBundles:function(cartResponse,salesId,callback=null){var itineraryItemId=parseInt(cartResponse.Data.ItemsAddedList);var lang=document.documentElement.lang;self.reset();var request={SalesId:salesId,ItineraryItemList:cartResponse.Data.UpsellItemList,Language:lang};self.salesId=request.salesId;self.UpsellItemList=cartResponse.Data.UpsellItemList;$.ajax({dataType:"json",url:self.options.getBundlesEndpoint,type:"GET",data:request,success:function(output){var textStepCount=output.Data.TextStepCount;var textMinMax=output.Data.TextMinMax;var item=self.findItineraryItem(output.Data.BundlesResponse.ItineraryItems,itineraryItemId);if(item!=null&&item.ProductBundleList.length>0){item.ProductBundleList.forEach(function(bundle,bindex){bundle.Order=bindex+1;bundle.MoreOptions=bundle.ChildProducts.length>cartResponse.Options.MoreOptionsQty;bundle.StepText=textStepCount.replace("{{CURRENT}}",bundle.Order).replace("{{LAST}}",item.ProductBundleList.length);bundle.MinMaxText=textMinMax.replace("{{MIN}}",bundle.MinAddOn).replace("{{MAX}}",bundle.MaxAddOn);self.bundles.push(bundle);var max=bundle.MaxAddOn;if(bundle.MinAddOn==0){bundle.MinAddOn=1}bundle.ChildProducts.forEach(function(product,pindex){var displayPrice=helpers.formatCurrency(product.Price,lang);var displayPriceShort=helpers.formatCurrencyShort(product.Price,lang);var cartItem={arrivalDate:item.ArrivalDate,departureDate:item.ArrivalDate,salesId:request.salesId,supplierId:product.ItemSupplierId,supplierName:product.SupplierName,productId:product.ItemProductId,adultCount:1,childCount:0,quantity:1,price:product.Price,id:product.ItemSupplierId+"-"+product.ItemProductId,productName:product.ProductName,categoryName:item.CategoryName,productBundleId:bundle.ProductBundleId,parentItemId:bundle.ItineraryItemId,displayPrice:displayPrice,displayPriceShort:displayPriceShort,productBundleId:bundle.ProductBundleId};product.CartItem=JSON.stringify(cartItem);if(product.Price%1==0){product.DisplayPrice=displayPriceShort}else{product.DisplayPrice=displayPrice}if(pindex>cartResponse.Options.MoreOptionsQty-1){product.Hide=true;bundle.HasMore=true}if(max>1){product.QtyBox=true}})});self.displayData.Item=item;self.displayData.StepCount=item.ProductBundleList.length;self.displayData.Text=self.getText(output.Data);var resultsHtml=mustache.render(bundlesTemplatePath,self.displayData);overlay.show(resultsHtml);self.bindEvents();stepForm=stepFormComponent.create();self.renderSelected()}if(callback!=null){callback()}}});return self},getText:function(data){var text={};text.AddedToCart=data.TextAddedToCart;text.BundlesTitle=data.TextBundlesTitle;text.BundlesDescription=data.TextBundlesDescription;text.MoreOptions=data.TextMoreOptions;text.Optional=data.TextOptional;text.NoThanks=data.TextNoThanks;text.NextStep=data.TextNextStep;text.DoneEdit=data.TextDoneEdit;text.Required=data.TextRequired;text.ReviewAddOns=data.TextReviewAddOns;text.SubTotal=data.TextSubTotal;text.RequiredMessage=data.TextRequiredMessage;text.AddToCart=data.TextAddToCart;text.Cancel=data.TextCancel;text.NoSelection=data.TextNoSelection;text.Done=data.TextDone;console.log(text);return text},findItineraryItem:function(arr,value){for(var i=0;i<arr.length;i++){if(arr[i].ItineraryItemId===parseInt(value))return arr[i]}return null},findBundle:function(bundleId){for(var i=0;i<self.bundles.length;i++){if(self.bundles[i].ProductBundleId===parseInt(bundleId))return self.bundles[i]}},bundleEditable:function(bundleId){return $(".bundle-"+bundleId).hasClass("editable")},overlayClosed:function(){overlay.remove()},showMoreOptions:function(e){$(e.target).closest(".bundle-options").removeClass("collapsed").addClass("expanded")},renderSelected:function(){var language=document.documentElement.lang;var subTotal=0;self.displayData.display=[];self.displayData.selected.forEach(function(item){subTotal+=item.price*item.quantity;for(var i=0;i<item.quantity;i++){self.displayData.display.push(item)}});self.displayData.subTotal=helpers.formatCurrency(subTotal,language);var resultsHtml=mustache.render(selectedTemplatePath,self.displayData);$(".selected-container").html(resultsHtml)},addToCart:function(e){e.preventDefault();self.itemsAddedCount=0;var cartItems=self.displayData.display;if(cartItems.length===0){$(document).trigger({type:"minicart.open"});overlay.remove();self.reset();return false}cartItems.forEach(function(item){item.quantity=1});self.parent.addBundlesToCart(cartItems,self.addedToCart);return false},addedToCart:function(output,items){self.parent.trackAddProductsToCart(self.displayData.display);$(document).trigger({type:"minicart.open"});overlay.remove();self.reset()},reset:function(){self.bundles=[];self.displayData.selected=[];self.editMode=false;$(".inntopia-bundles .bundles-list").removeClass("edit");stepForm=null}};return self.init()};return{create:create}});