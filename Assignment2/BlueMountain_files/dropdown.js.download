define(function(require){"use strict";var $=require("jquery");require("touchSwipe");var settings={contextEl:$(document.body),dropdown:null,toggleSelector:".button",toggle:false,toggleTextSelector:null,optionsSelector:".options",optionsButtonSelector:"button",openClass:"open",selectedClass:"selected",constrainWidth:true,openKeys:[13,32,38,40],closeKeys:[27],arrowKeys:[38,40],selectionKeys:[13,32],anchorRight:true,putOpenClassOnContext:false,closeOptionsCallback:$.noop()};var instances=[];function create(options){var self={};self.options=$.extend({},settings,options);bind(self);self.cacheDom();self.setClasses();self.setDimensions();self.attachHandlers();instances.push(self);return self}function bind(self){self.cacheDom=cacheDom.bind(self);self.setInput=setInput.bind(self);self.setDimensions=setDimensions.bind(self);self.getInitialOptionsHeight=getInitialOptionsHeight.bind(self);self.attachHandlers=attachHandlers.bind(self);self.toggleKeys=toggleKeys.bind(self);self.optionKeys=optionKeys.bind(self);self.setNewFocusIndex=setNewFocusIndex.bind(self);self.openDropdown=openDropdown.bind(self);self.closeDropdowns=closeDropdowns.bind(self);self.handleBodyClick=handleBodyClick.bind(self);self.optionClick=optionClick.bind(self);self.changeSelection=changeSelection.bind(self);self.setClasses=setClasses.bind(self);self.isDesktop=isDesktop.bind(self);self.isMobile=isMobile.bind(self);self.recacheDynamicFields=recacheDynamicFields.bind(self);self.changeBookingOptionValue=changeBookingOptionValue.bind(self)}function cacheDom(){this.dom={};this.dom.body=$(document.body);this.dom.context=this.options.contextEl;this.dom.dropdown=this.options.dropdown;this.dom.toggleButton=this.dom.context.find(this.options.toggleSelector).not(".cover-button");this.dom.toggleButtonCover=this.dom.context.find(".cover-button");if(this.options.toggleTextSelector){this.dom.toggleButtonText=this.dom.toggleButton.find(this.options.toggleTextSelector);this.dom.toggleButtonCoverText=this.dom.toggleButtonCover.find(this.options.toggleTextSelector)}this.dom.options=this.dom.dropdown.find(this.options.optionsSelector);this.dom.optionButtons=this.dom.options.find(this.options.optionsButtonSelector);this.dom.input=this.setInput();this.dom.predictiveSearchInputs=this.dom.context.find(".cover-button .predictive-search-input")}function recacheDynamicFields(){this.dom.toggleButtonText=this.dom.toggleButton.find(this.options.toggleTextSelector);this.dom.toggleButtonCoverText=this.dom.toggleButtonCover.find(this.options.toggleTextSelector)}function setInput(){var input=this.dom.dropdown.data("field"),el=document.getElementById(input);return $(el)}function setClasses(){if(!this.options.anchorRight){this.dom.options.addClass("anchor-left")}}function setDimensions(){if(this.options.constrainWidth){var width=typeof this.options.constrainWidth==="boolean"?this.dom.dropdown.outerWidth():this.options.constrainWidth;this.dom.dropdown.css("width",width)}}function getInitialOptionsHeight(){this.dom.options.css({display:"block",position:"fixed"});var height=this.dom.options.outerHeight();this.dom.options.removeAttr("style");return height}function attachHandlers(){this.dom.toggleButton.on("touchstart click",this.openDropdown);this.dom.toggleButton.on("keydown",this.toggleKeys);this.dom.optionButtons.on("keydown",this.optionKeys);this.dom.body.on("click",this.handleBodyClick);this.dom.optionButtons.swipe({tap:this.optionClick});this.dom.predictiveSearchInputs.on("click",function(e){e.stopImmediatePropagation()});this.dom.predictiveSearchInputs.on("change keyup",function(e){e.stopImmediatePropagation();filterDropdownList({$input:$(this),containerClass:'div[class*="widget"]',optionsClass:".options li"})})}function toggleKeys(e){if(this.options.openKeys.indexOf(e.keyCode)>=0){this.openDropdown(e);this.dom.optionButtons.eq(0).trigger("focus")}}function optionKeys(e){var button=$(e.currentTarget);if(this.options.arrowKeys.indexOf(e.keyCode)>=0){e.preventDefault();var index=this.dom.optionButtons.index(button),offset=e.keyCode==38?-1:1,updatedIndex=this.setNewFocusIndex(index,offset);this.dom.optionButtons.eq(updatedIndex).trigger("focus")}if(this.options.closeKeys.indexOf(e.keyCode)>=0){this.closeDropdowns();this.dom.toggleButton.trigger("focus")}if(this.options.selectionKeys.indexOf(e.keyCode)>=0){this.changeSelection($(e.target).attr("data-value"))}}function setNewFocusIndex(index,offset){var newIndex=index+offset,len=this.dom.optionButtons.length;if(newIndex<=0){newIndex=len-1}else if(newIndex>=len){newIndex=0}return newIndex}function openDropdown(e){if(!e.currentTarget.href){e.preventDefault()}e.stopPropagation();var wasOpen=this.options.putOpenClassOnContext?this.dom.context.hasClass(this.options.openClass):this.dom.dropdown.hasClass(this.options.openClass);this.closeDropdowns();if(this.options.closeOptionsCallback){this.options.closeOptionsCallback();if(this.dom.context.find(".cover-button .predictive-search-container").length>0){setPredictiveInputToFullName({$container:this.dom.context,containerClass:'div[class*="widget"]',optionsClass:".options li",selectClass:"select.results-select",inputClass:".cover-button input"});var $this=this.dom.context;setTimeout(function(){$this.find(".cover-button input").focus()},1)}}if(this.options.toggle&&wasOpen){return}if(this.options.putOpenClassOnContext){this.dom.context.addClass(this.options.openClass)}else{this.dom.dropdown.addClass(this.options.openClass)}}function closeDropdowns(){var dropdownContainer=this,openClass=dropdownContainer.options.openClass;instances.forEach(function(instance){if(dropdownContainer.options.putOpenClassOnContext){dropdownContainer.dom.context.removeClass(openClass)}else{dropdownContainer.dom.dropdown.removeClass(openClass)}})}function handleBodyClick(e){var clicked=$(e.target),close=!clicked.parents().is(this.dom.dropdown);if(close){this.closeDropdowns()}}function optionClick(e){e.preventDefault();e.stopPropagation();this.changeSelection($(e.currentTarget).attr("data-value"))}function changeSelection(value,silent){var selectedText;this.dom.optionButtons.removeClass(this.options.selectedClass);this.dom.optionButtons.parent().attr("aria-selected","false");this.dom.input.val(value);this.closeDropdowns();var selectedOption=this.dom.optionButtons.filter('[data-value="'+value+'"]');selectedOption.addClass("selected");selectedOption.parent().attr("aria-selected","true");selectedText=selectedOption.text();if(selectedOption.length>1){selectedText=$(selectedOption[0]).text()}var baseSelectedText=selectedText;if(this.dom.context.find(".cover-button .predictive-search-container").length>0){baseSelectedText=selectedText;if(value){selectedText='<span class="desktop">'+selectedText+'</span><span class="mobile">'+value+"</span>"}}if(this.dom.context.hasClass("booking-option")){this.changeBookingOptionValue(baseSelectedText)}this.recacheDynamicFields();if(this.options.toggleTextSelector){this.dom.toggleButtonText.html(selectedText);this.dom.toggleButtonCoverText.html(baseSelectedText)}else{this.dom.toggleButton.html(selectedText)}if(!silent){this.dom.dropdown.trigger("change",value)}this.dom.toggleButton.trigger("focus")}function changeBookingOptionValue(baseSelectedText){var subtextStyle="";var textStyle="";if(isMobile()){subtextStyle="width:auto; display: inline-block;";textStyle="width:auto;"}var labels=this.dom.context.find(".booking-option-label").not(".predictive-search-container"),mainLabels=labels.not(".cover-button-label"),subtext=labels.find(".subtext"),text=labels.find(".text"),mainText=mainLabels.find(".text");if(!mainText.attr("data-default-text")){var defaultText=mainLabels.text().trim();if(mainLabels.find(".desktop").length){defaultText=mainLabels.find(".desktop").text().trim()}mainText.attr("data-default-text",defaultText)}if(baseSelectedText.trim()===mainText.attr("data-default-text").trim()){if(subtext.length){text.remove();subtext.addClass("text content-text").removeClass("subtext")}}else if(!subtext.length){labels.prepend('<div class="subtext" style="'+subtextStyle+'">'+mainText.attr("data-default-text")+"</div>")}else if(!subtext.text().trim()){subtext.text(mainText.attr("data-default-text"));subtext.css("style",subtextStyle)}text.css("style",textStyle)}function isDesktop(){return Modernizr.mq("only screen and (min-width: 1200px)")}function isMobile(){return Modernizr.mq("only screen and (max-width: 767px)")}function filterDropdownList(options){var filterVal=options.$input.val().toLocaleLowerCase(),$container=options.$input.closest(options.containerClass),$options=$container.find(options.optionsClass),$firstOption=$options.first(),$firstOptionButton=$firstOption.find("span");$options.removeClass("hidden");$firstOptionButton.text($firstOptionButton.data("text"));if(filterVal.length>1){var allHidden=true;var shownCount=0;$options.each(function(i,e){var $thisElem=$(e),text=$thisElem.text().toLocaleLowerCase(),val=$thisElem.find("span").data("value").toLocaleLowerCase();if(i===0||text.indexOf(filterVal)===-1&&val.indexOf(filterVal)===-1){$thisElem.addClass("hidden")}else{allHidden=false;shownCount++}});if(shownCount<6){$container.addClass("hide-custom-scroll")}else{$container.removeClass("hide-custom-scroll")}if(allHidden){$firstOptionButton.text($firstOptionButton.data("noresults"));$firstOption.removeClass("hidden")}}else{unfilterDropdownList({$input:options.$input,containerClass:options.containerClass,optionsClass:options.optionsClass})}}function unfilterDropdownList(options){var $container=options.$input.closest(options.containerClass),$options=$container.find(options.optionsClass),$firstOption=$options.first(),$firstOptionButton=$firstOption.find("span");$firstOptionButton.text($firstOptionButton.data("text"));$options.removeClass("hidden");if($options.length<6){$container.addClass("hide-custom-scroll")}else{$container.removeClass("hide-custom-scroll")}}function setPredictiveInputToFullName(options){var select=options.$container.find(options.selectClass)[0],$input=options.$container.find(options.inputClass);$input.val("");if(select&&select.selectedIndex!==0){$input.val(select.options[select.selectedIndex].text)}unfilterDropdownList({$input:$input,containerClass:options.containerClass,optionsClass:options.optionsClass})}return{create:create}});