define(function(require){var $=require("jquery"),helpers=require("helpers"),ResponsiveTable=require("ResponsiveTable"),mustache=require("mustache"),MicroModal=require("micromodal"),modalTemplate=require("text!/public/Shared/templates/rte-lightbox/rte-image-lightbox.html"),imageExpandIcons={},dom;init();function init(){cacheDom();prepareImageLightboxes();acquireImageExpandIcons();attachHandlers();var isFullMobileTable=$(".rich-text").hasClass("full-mobile-table");if(!helpers.isPageEditor&&!isFullMobileTable){$(".rich-text table").each(function(){var responsiveTable=$(this).hasClass("responsive-table")||$(this).hasClass("responsive-table-variation");var spannedTitle=$(this).hasClass("spanned-title-table");if(responsiveTable){return}ResponsiveTable.create({root:this,spannedTitle:spannedTitle})})}if(dom.rteLightboxSpans.length>0){MicroModal.init()}resizeTable()}function cacheDom(){dom={};dom.window=$(window);dom.body=$("body");dom.rteLightboxSpans=$(".rich-text").find(".rte-image-expand");dom.rteLightboxImgs=dom.rteLightboxSpans.find("img")}function prepareImageLightboxes(){if(dom.rteLightboxSpans.length>0){var modalId=null;dom.rteLightboxSpans.each(function(idx,el){var img=$($(el).find("img")),imgForLightbox=$($(el).find("img").clone()[0]),imgUrlSplit=imgForLightbox.attr("src").split("?"),imgUrlBase=imgUrlSplit[0],imgUrlParams=imgUrlSplit[1];img.attr("tabindex","0");img.attr("role","button");img.attr("aria-label","expand image");imgForLightbox.removeAttr("style height width");var urlSearchParams=new URLSearchParams(imgUrlParams),urlSrc=imgForLightbox.attr("src");if(urlSearchParams.has("hash")){urlSrc=imgUrlBase+"?hash="+urlSearchParams.get("hash");imgForLightbox.attr("src",urlSrc)}modalId="rte-image-"+idx;var faExpandIcon=$("<span></span>").addClass("rte-image-expand-icon fa fa-expand-alt").attr("aria-hidden","true");img.parent().append(faExpandIcon);var modalTopEl=$('<div id="'+modalId+'"></div>').addClass("rte-image-overlay rte-lightbox").attr("aria-hidden","true");modalTopEl.insertAfter(el);var imgModalData={imgSrc:urlSrc,imgIdx:idx};var modalHtml=mustache.render(modalTemplate,imgModalData);modalTopEl.html(modalHtml)})}}function acquireImageExpandIcons(){imageExpandIcons=$(".rte-image-expand-icon")}function attachHandlers(){dom.window.on("resize",resizeTable);if(dom.rteLightboxSpans.length>0){dom.rteLightboxImgs.on("click keyup",showLightbox);imageExpandIcons.on("click keyup",showLightbox)}}function resizeTable(){$(".rich-text .rte-table-wrapper").each(function(){var rteWrapper=$(this),table=$(rteWrapper.find("table").first()),placeholder=$(rteWrapper.closest(".placeholder-item")),is33Ph=placeholder.parent().hasClass("three-33s"),is50Ph=placeholder.parent().hasClass("two50-50"),bp33=350,bp50=425;if(rteWrapper.parents(".full-mobile-table").length>0){return}rteWrapper.css("scroll-x","scroll");if(is50Ph&&placeholder.width()<bp50||is33Ph&&placeholder.width()<bp33||this.scrollWidth>this.offsetWidth){table.css("display","none");rteWrapper.find(".mobile-table").each(function(){$(this).css("display","table")});table.attr("data-breakpoint",table.width())}if(is50Ph&&placeholder.width()>=bp50||is33Ph&&placeholder.width()>=bp33||this.offsetWidth>=table.attr("data-breakpoint")){table.css("display","table");rteWrapper.find(".mobile-table").each(function(){$(this).css("display","none")})}rteWrapper.css("scroll-x","hidden")})}function showLightbox(e){if(helpers.a11yClick(e)===true){this.blur();var modalId=$(this).parent().next(".rte-image-overlay.rte-lightbox").attr("id");if(modalId!==null){dom.body.addClass("rte-lightbox-open");MicroModal.show(modalId,{onClose:closeLightbox});e.preventDefault()}}}function closeLightbox(){dom.body.removeClass("rte-lightbox-open")}});