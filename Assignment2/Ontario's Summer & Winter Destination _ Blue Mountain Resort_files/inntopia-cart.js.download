define("inntopia-cart",function(require){var minDate=new Date;minDate.setDate(minDate.getDate()-1);var $=require("jquery"),helpers=require("helpers"),inntopiaBundles=require("inntopia-bundles"),bundles=null,defaults={addEndPoint:"/api/InntopiaCart/AddToCart",addPackageItemEndPoint:"/api/InntopiaCart/AddPackageItemToCart",AddBundlesEndPoint:"/api/InntopiaCart/AddBundledItemsToCart",addUpsellsEndPoint:"/api/InntopiaCart/AddUpsellsToCart",salesId:0,addAnalytics:true};var create=function(options){var self={options:$.extend({},defaults,options),init:function(){bundles=inntopiaBundles.create(null,self);return self},showSpinner:function(e,buttonClass){var target;if($(e.target).hasClass(buttonClass)){target=e.target}else{target=e.target.closest(buttonClass)}if($(target).hasClass("add-spinner")){return false}$(buttonClass).addClass("add-spinner");$(target).addClass("loading").addClass("add-spinner");return true},addToCart:function(tmpCartItem,callBack){var cartItem={ArrivalDate:tmpCartItem.arrivalDate,DepartureDate:tmpCartItem.departureDate,AdultCount:tmpCartItem.adultCount,ChildCount:tmpCartItem.childCount,SalesId:tmpCartItem.salesId,SupplierId:tmpCartItem.supplierId,ProductId:tmpCartItem.productId,Quantity:tmpCartItem.quantity,ParentItemId:tmpCartItem.parentItemId,ProductBundleId:tmpCartItem.productBundleId};var request={item:cartItem,salesId:self.options.salesId};$.ajax({dataType:"json",url:self.options.addEndPoint,type:"POST",data:request,success:function(output){self.addSuccess(output,tmpCartItem,callBack)},error:self.addError});return self},addBundlesToCart:function(tmpBundles,callBack){var cartItem=tmpBundles.map(function(tmpCartItem){return{ArrivalDate:tmpCartItem.arrivalDate,DepartureDate:tmpCartItem.departureDate,AdultCount:tmpCartItem.adultCount,ChildCount:tmpCartItem.childCount,SalesId:tmpCartItem.salesId,SupplierId:tmpCartItem.supplierId,ProductId:tmpCartItem.productId,Quantity:tmpCartItem.quantity,ParentItemId:tmpCartItem.parentItemId,ProductBundleId:tmpCartItem.productBundleId}});var request={items:cartItem,salesId:self.options.salesId};$.ajax({dataType:"json",url:self.options.AddBundlesEndPoint,type:"POST",data:request,success:function(output){self.addBundleSuccess(output,tmpBundles,callBack)},error:self.addError});return self},addPackageItemToCart:function(tmpCartItem,callBack){var cartItem={ArrivalDate:tmpCartItem.arrivalDate,DepartureDate:tmpCartItem.departureDate,AdultCount:tmpCartItem.adultCount,ChildCount:tmpCartItem.childCount,SupplierId:tmpCartItem.supplierId,ProductId:tmpCartItem.productId,Quantity:tmpCartItem.quantity,PackageId:tmpCartItem.packageId,CustomerRequirements:tmpCartItem.customerRequirements};var request={item:cartItem,salesId:self.options.salesId};$.ajax({dataType:"json",url:self.options.addPackageItemEndPoint,type:"POST",data:request,success:function(output){self.addSuccess(output,tmpCartItem,callBack)},error:self.addError});return self},addUpsellsToCart:function(upsellsModel,callBack){$.ajax({contentType:"application/json; charset=utf-8",url:self.options.addUpsellsEndPoint,type:"POST",data:JSON.stringify(upsellsModel),success:function(output){if(output.Success){$(document).trigger({type:"minicart.updateCount"});var addedItems=JSON.parse(output.Data);self.trackAddProductsToCart(addedItems);if(callBack!=null){callBack(output,addedItems)}}else{console.error("Something went wrong")}},error:function(xhr,ajaxOptions,thrownError){console.error(xhr.status);console.error(thrownError)}});return self},removeFromCart:function(itineraryItemId,cartData){var removedItem;if(cartData){var cartObj=JSON.parse(cartData);for(var i=0;i<cartObj.cartItems.length;i++){if(cartObj.cartItems[i].itineraryItemId===itineraryItemId){removedItem=cartObj.cartItems[i];break}}}var url="/api/InntopiaCart/RemoveFromCart";$.ajax({dataType:"json",url:url,type:"POST",data:{itineraryItemId:itineraryItemId,returnCart:true},success:function(output){if(output.Success){if(removedItem){self.trackRemoveProductFromCart(removedItem)}$(document).trigger("minicart.updateCount",output.Message);$(document).trigger({type:"cart.update"})}}});return false},addSuccess:function(output,cartItem,callBack){if(output.Success){$(document).trigger({type:"minicart.open"});cartItem.itineraryId=output.Data.ItineraryId;self.trackAddProductToCart(cartItem);if(callBack!=null){callBack(output,cartItem)}if(output.Options.BundlesEnabled&&output.Data.UpsellItemList.length>0){bundles.getBundles(output,self.options.salesId,self.bundlesLoaded)}else{$(".add-spinner").removeClass("loading").removeClass("add-spinner")}}else{console.error("Something went wrong");$(".add-spinner").removeClass("loading").removeClass("add-spinner")}},bundlesLoaded:function(){$(".add-spinner").removeClass("loading").removeClass("add-spinner")},addBundleSuccess:function(output,cartItem,callBack){if(output.Success){cartItem.itineraryId=output.Data.ItineraryId;if(callBack!=null){callBack(output,cartItem)}}else{console.error("Something went wrong")}$(".add-spinner").removeClass("loading").removeClass("add-spinner")},addError:function(xhr,ajaxOptions,thrownError){console.error(xhr.status);console.error(thrownError);$(".add-spinner").removeClass("loading").removeClass("add-spinner")},trackAddProductToCart:function(cartItem){var analyticsId=helpers.getAnalyticsId(cartItem.supplierId,cartItem.productId);var dataLayer={event:"addToCart",source:"sitecore",ecommerce:{currencyCode:"USD",add:{products:[{name:cartItem.productName,id:analyticsId,productId:cartItem.productId,price:cartItem.price.toString(),brand:cartItem.supplierName,category:cartItem.CategoryName,quantity:1,location:cartItem.locationName,adultCount:cartItem.adultCount,childCount:cartItem.childCount,arrivalDate:cartItem.arrivalDate,departureDate:cartItem.departureDate,totalNights:cartItem.totalNights,itineraryId:cartItem.itineraryId===null||cartItem.itineraryId===undefined?"0":cartItem.itineraryId.toString(),packageId:cartItem.packageId,packageName:cartItem.packageName,supplierId:cartItem.supplierId,categoryName:cartItem.categoryName}]}}};window.dataLayer=window.dataLayer||[];window.dataLayer.push(dataLayer)},trackAddProductsToCart:function(cartItems){var products=[];cartItems.forEach(function(item){var cartItem=helpers.toCamel(item);var analyticsId=helpers.getAnalyticsId(cartItem.supplierId,cartItem.productId);var product={name:cartItem.productName,id:analyticsId,productId:cartItem.productId,price:cartItem.price.toString(),brand:cartItem.supplierName,category:cartItem.CategoryName,quantity:1,location:cartItem.locationName,adultCount:cartItem.adultCount,childCount:cartItem.childCount,arrivalDate:cartItem.arrivalDate,departureDate:cartItem.departureDate,totalNights:cartItem.totalNights,itineraryId:cartItem.itineraryId===null||cartItem.itineraryId===undefined?"0":cartItem.itineraryId.toString(),packageId:cartItem.packageId,packageName:cartItem.packageName,supplierId:cartItem.supplierId,categoryName:cartItem.categoryName};products.push(product)});var dataLayer={event:"addToCart",source:"sitecore",ecommerce:{currencyCode:"USD",add:{products:products}}};window.dataLayer=window.dataLayer||[];window.dataLayer.push(dataLayer)},trackRemoveProductFromCart:function(cartItem){cartItem=helpers.toCamel(cartItem);var analyticsId=helpers.getAnalyticsId(cartItem.supplierId,cartItem.productId);var dataLayer={event:"removeFromCart",source:"sitecore",ecommerce:{currencyCode:"USD",remove:{products:[{name:cartItem.productName,id:analyticsId,productId:cartItem.productId,price:cartItem.price.toString(),brand:cartItem.supplierName,category:cartItem.CategoryName,quantity:1,location:cartItem.locationName,adultCount:cartItem.adultCount,childCount:cartItem.childCount,arrivalDate:cartItem.arrivalDate,departureDate:cartItem.departureDate,totalNights:cartItem.totalNights,itineraryId:cartItem.itineraryId===null||cartItem.itineraryId===undefined?"0":cartItem.itineraryId.toString(),packageId:cartItem.packageId,packageName:cartItem.packageName,supplierId:cartItem.supplierId,categoryName:cartItem.categoryName}]}}};window.dataLayer=window.dataLayer||[];window.dataLayer.push(dataLayer)},makeSelector:function(cssClass){var arr=cssClass.split(/\s+/);var selector="."+arr.join(".");return selector}};return self.init()};return{create:create}});